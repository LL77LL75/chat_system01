<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chat App — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">

  <!-- Load application modules (they import firebase-config.js internally) -->
  <script type="module" src="app.js"></script>
  <script type="module" src="chat.js"></script>
</head>
<body>
  <div class="dashboard-container">

    <!-- LEFT: account panel -->
    <section class="panel account-panel" aria-labelledby="accountTitle">
      <h3 id="accountTitle">Account</h3>

      <!-- Account popup trigger -->
      <button class="button-link" id="open-account-btn"
              onclick="document.getElementById('account-popup').style.display='block'">
        Account
      </button>

      <!-- Logout -->
      <button class="button-link" onclick="window._LOGOUT && window._LOGOUT()">Logout</button>

      <!-- Create user for core/pioneer (shown by JS when permitted) -->
      <div style="margin-top:12px;">
        <button id="create-user-btn" class="button-link" style="display:none;"
                onclick="window.createUserPrompt && window.createUserPrompt()">
          Create Account
        </button>
      </div>
    </section>

    <!-- MIDDLE: room list -->
    <section class="panel room-panel" aria-labelledby="roomsTitle">
      <h3 id="roomsTitle">Rooms</h3>

      <!-- Buttons are generated by chat.js/app.js -->
      <div id="room-list" style="display:flex; flex-wrap:wrap; gap:6px;"></div>

      <div style="margin-top:12px;">
        <label for="new-room-code">Create room (admins):</label>
        <input id="new-room-code" placeholder="Room code" style="width:140px">
        <button class="button-link" onclick="(async()=>{ const c=document.getElementById('new-room-code').value.trim(); if(c) await window.createRoom && window.createRoom(c); })()">Create</button>
      </div>
    </section>

    <!-- RIGHT: selected room info -->
    <section class="panel room-info-panel" aria-labelledby="infoTitle">
      <h3 id="infoTitle">Room Info</h3>

      <div id="room-info">Click a room button to view details here.</div>

      <div style="margin-top:10px;">
        <button id="join-selected-btn" class="button-link" style="display:none;"
                onclick="window.joinSelected && window.joinSelected()">
          Join Room
        </button>
      </div>
    </section>
  </div>

  <!-- BIG ACCOUNT POPUP -->
  <div id="account-popup" class="popup" aria-hidden="true" style="display:none;">
    <h3>Account Settings</h3>

    <label for="acct-display">Display name</label>
    <input id="acct-display" type="text" placeholder="Your display name">

    <label for="acct-password">Password</label>
    <input id="acct-password" type="password" placeholder="Change password">

    <label for="acct-title">Equipped title</label>
    <select id="acct-title">
      <!-- populated dynamically by app.js -->
    </select>

    <div style="margin-top:10px; display:flex; gap:8px; flex-direction:column;">
      <button class="button-link" onclick="(async()=>{ const d=document.getElementById('acct-display').value.trim(); if(d) await window._CHANGE_DISPLAY && window._CHANGE_DISPLAY(d); })()">Change Display Name</button>

      <button class="button-link" onclick="(async()=>{ const p=document.getElementById('acct-password').value; if(p) await window._CHANGE_PASSWORD && window._CHANGE_PASSWORD(p); })()">Change Password</button>

      <button class="button-link" onclick="(async()=>{ const t=document.getElementById('acct-title').value; if(t) await window._CHANGE_TITLE && window._CHANGE_TITLE(t); })()">Change Title</button>

      <button class="button-link" onclick="(async()=>{ const ttl=prompt('Auction title (quoted optional)'); const bid=prompt('Starting bid'); const mins=prompt('Duration in minutes (max per rank enforced)'); if(ttl && bid && mins) await window.startAuction && window.startAuction(ttl,bid,mins); })()">Start Auction</button>

      <button class="button-link" onclick="window.openShop && window.openShop()">Open Shop</button>

      <button class="button-link" onclick="document.getElementById('account-popup').style.display='none'">Close</button>
    </div>
  </div>

  <script>
    // Basic runtime wiring — UI initialization
    (function(){
      // show Create Account button if permitted (app.js will set currentUser on load)
      const showCreateBtn = () => {
        try {
          const cu = JSON.parse(localStorage.getItem('currentUser')||'{}');
          if(cu && (cu.rank==='core' || cu.rank==='pioneer')) {
            document.getElementById('create-user-btn').style.display = 'inline-block';
          }
          // populate account popup fields if currentUser available
          if(cu && cu.displayName) {
            document.getElementById('acct-display').value = cu.displayName || '';
          }
        } catch(e){}
      };

      // When modules finish loading they may trigger an event; poll briefly
      let tries = 0;
      (function waitForCU(){
        tries++;
        if(window.currentUser && Object.keys(window.currentUser).length){
          showCreateBtn();
          return;
        }
        if(tries<20) setTimeout(waitForCU,150);
      })();
    })();
  </script>
</body>
</html>
