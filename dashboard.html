<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App – Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js"></script>
  <script type="module" src="firebase-config.js"></script>
</head>
<body>
  <header>
    <h1>Dashboard</h1>
    <button id="accountBtn">Account</button>
    <div id="accountMenu" class="hidden">
      <button id="settingsBtn">Settings</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <main>
    <section id="rooms-section">
      <h2>Available Rooms</h2>
      <ul id="roomList"></ul>
      <div id="adminRoomControls" class="hidden">
        <input type="text" id="newRoomCode" placeholder="Enter room code">
        <button id="createRoomBtn">Create / Join Room</button>
        <button id="deleteRoomBtn">Delete Room</button>
      </div>
    </section>

    <section id="requests-section" class="hidden">
      <h2>Registration Requests</h2>
      <ul id="requestList"></ul>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const accountBtn = document.getElementById('accountBtn');
    const accountMenu = document.getElementById('accountMenu');
    const settingsBtn = document.getElementById('settingsBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const roomListEl = document.getElementById('roomList');
    const newRoomCodeInput = document.getElementById('newRoomCode');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const deleteRoomBtn = document.getElementById('deleteRoomBtn');
    const adminRoomControls = document.getElementById('adminRoomControls');

    const requestsSection = document.getElementById('requests-section');
    const requestListEl = document.getElementById('requestList');

    let currentUser = localStorage.getItem('chatUser');
    let currentRank = localStorage.getItem('chatRank') || 'newbie';

    if (!currentUser) {
      window.location = 'index.html';
    }

    accountBtn.onclick = () => accountMenu.classList.toggle('hidden');
    logoutBtn.onclick = () => {
      localStorage.removeItem('chatUser');
      localStorage.removeItem('chatRank');
      window.location = 'index.html';
    };

    // Show controls based on rank
    if (['admin','high','core','pioneer'].includes(currentRank)) {
      adminRoomControls.classList.remove('hidden');
    }
    if (['core','pioneer'].includes(currentRank)) {
      requestsSection.classList.remove('hidden');
    }

    // Load rooms list
    const roomsRef = ref(db, 'rooms');
    onValue(roomsRef, snapshot => {
      const rooms = snapshot.val() || {};
      roomListEl.innerHTML = '';
      Object.keys(rooms).forEach(code => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.innerText = `Join ${code}`;
        btn.onclick = () => window.location = `chat.html?room=${encodeURIComponent(code)}`;
        li.appendChild(btn);
        roomListEl.appendChild(li);
      });
    });

    // Load registration requests
    const reqRef = ref(db, 'registrationRequests');
    onValue(reqRef, snapshot => {
      const requests = snapshot.val() || {};
      requestListEl.innerHTML = '';
      Object.entries(requests).forEach(([username, info]) => {
        if (info.status === "pending") {
          const li = document.createElement('li');
          li.innerText = `${username} — requested at ${new Date(info.requestedAt).toLocaleString()}`;
          const approveBtn = document.createElement('button');
          approveBtn.innerText = 'Approve';
          approveBtn.onclick = async () => {
            // Approve: move to users, set rank newbie
            await set(ref(db, `users/${username}`), {
              password: info.password,
              rank: "newbie",
              status: "active",
              credits: 0,
              titles: ["newcomer"]
            });
            await remove(ref(db, `registrationRequests/${username}`));
            alert(`User ${username} approved.`);
          };
          const rejectBtn = document.createElement('button');
          rejectBtn.innerText = 'Reject';
          rejectBtn.onclick = async () => {
            await remove(ref(db, `registrationRequests/${username}`));
            alert(`User ${username} rejected.`);
          };
          li.appendChild(approveBtn);
          li.appendChild(rejectBtn);
          requestListEl.appendChild(li);
        }
      });
    });

    createRoomBtn.onclick = () => {
      const code = newRoomCodeInput.value.trim();
      if (!code) return;
      const roomRef = ref(db, `rooms/${code}`);
      get(roomRef).then(snapshot => {
        if (snapshot.exists()) {
          window.location = `chat.html?room=${encodeURIComponent(code)}`;
        } else {
          set(roomRef, { createdBy: currentUser, messages:{}, participants:{} })
            .then(() => window.location = `chat.html?room=${encodeURIComponent(code)}`);
        }
      });
    };

    deleteRoomBtn.onclick = () => {
      if (['admin','high','core','pioneer'].includes(currentRank)) {
        const code = newRoomCodeInput.value.trim();
        if (!code) return;
        remove(ref(db, `rooms/${code}`))
          .then(() => alert('Room deleted: ' + code))
          .catch(err => alert('Error deleting room: ' + err.message));
      } else {
        alert('Permission denied');
      }
    };
  </script>
</body>
</html>
