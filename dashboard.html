<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App â€“ Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="app.js"></script>
    <script type="module" src="chat.js"></script>
</head>
<body>

<div class="dashboard-container">

    <!-- Account Panel -->
    <div class="account-panel">
        <h3>Account</h3>
        <a href="#" class="button-link" onclick="_accPop()">Settings</a>
        <a href="#" class="button-link" onclick="_LOGOUT()">Logout</a>
        <div id="core-pioneer-create" style="margin-top:10px;">
            <!-- Core/Pioneer can create accounts -->
            <button onclick="_CREATE_USER()" style="display:none;" id="create-user-btn">Create User</button>
        </div>
    </div>

    <!-- Room List -->
    <div class="room-panel">
        <h3>Rooms</h3>
        <div id="room-list" style="display:flex; flex-wrap:wrap; gap:5px;">
            <!-- Room buttons will be populated dynamically -->
        </div>
    </div>

    <!-- Selected Room Panel -->
    <div class="room-members-panel">
        <h3>Members</h3>
        <ul id="members-list"></ul>
        <h4>Banned Users</h4>
        <ul id="banned-users"></ul>
        <h4>Muted Users</h4>
        <ul id="muted-users"></ul>
        <button onclick="_GO_CHAT(selectedRoom)">Join Selected Room</button>
    </div>

</div>

<script type="module">
import { db } from './firebase-config.js';
import { ref, get, onValue } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js';

let selectedRoom = null;

// Show Create User button for Core/Pioneer
if (["core","pioneer"].includes(window.currentUser.rank)) {
    document.getElementById("create-user-btn").style.display = "block";
}

// Populate room buttons
const roomsRef = ref(db, "rooms");
onValue(roomsRef, snapshot => {
    const roomListDiv = document.getElementById("room-list");
    roomListDiv.innerHTML = "";
    snapshot.forEach(child => {
        const roomCode = child.key;
        const btn = document.createElement("button");
        btn.textContent = roomCode;
        btn.style.marginRight = "5px";
        btn.onclick = () => selectRoom(roomCode);
        roomListDiv.appendChild(btn);
    });
});

function selectRoom(roomCode){
    selectedRoom = roomCode;

    // Update members panel
    const membersUl = document.getElementById("members-list");
    const bannedUl = document.getElementById("banned-users");
    const mutedUl = document.getElementById("muted-users");

    membersUl.innerHTML = "";
    bannedUl.innerHTML = "";
    mutedUl.innerHTML = "";

    const membersRef = ref(db, `rooms/${roomCode}/members`);
    get(membersRef).then(snap => {
        if (!snap.exists()) return;
        const members = snap.val();
        for (const username in members){
            const li = document.createElement("li");
            li.textContent = members[username].displayName;
            membersUl.appendChild(li);
        }
    });

    // Show banned/muted only if user is admin+
    if (["admin","high","core","pioneer"].includes(window.currentUser.rank)){
        const bansRef = ref(db, `rooms/${roomCode}/bans/users`);
        get(bansRef).then(snap=>{
            const bans = snap.exists()? snap.val(): {};
            for (const u in bans){
                const li = document.createElement("li");
                li.textContent = `${u} (Level ${bans[u]})`;
                bannedUl.appendChild(li);
            }
        });

        const mutesRef = ref(db, `rooms/${roomCode}/mutes/users`);
        get(mutesRef).then(snap=>{
            const mutes = snap.exists()? snap.val(): {};
            for (const u in mutes){
                const li = document.createElement("li");
                li.textContent = `${u} (Level ${mutes[u]})`;
                mutedUl.appendChild(li);
            }
        });
    }
}
</script>

</body>
</html>
