<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Room</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Chat Room</h1>
    <button id="accountBtn">Account</button>
    <div id="accountMenu" class="hidden">
      <button id="settingsBtn">Settings</button>
      <button id="changeTitleBtn">Change Title</button>
      <button id="logoutBtn">Logout</button>
    </div>
    <button id="leaveBtn">Leave Chat</button>
  </header>

  <main>
    <section id="chat-section">
      <div id="chatBox"></div>
      <input type="text" id="msgInput" placeholder="Type your message..." />
      <button id="sendBtn">Send</button>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const dbRef = path => ref(db, path);
    const currentUser = localStorage.getItem('chatUser');
    const currentRank = localStorage.getItem('chatRank') || 'newbie';
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');

    if (!currentUser) {
      window.location = 'index.html';
    }

    document.getElementById('accountBtn').onclick = () => {
      document.getElementById('accountMenu').classList.toggle('hidden');
    };

    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('chatUser');
      localStorage.removeItem('chatRank');
      window.location = 'index.html';
    };

    document.getElementById('changeTitleBtn').onclick = async () => {
      const newTitle = prompt('Enter your new title:');
      if (newTitle) {
        const titlesSnap = await get(dbRef(`users/${currentUser}/titles`));
        let titles = titlesSnap.exists() ? titlesSnap.val() : [];
        titles.push(newTitle);
        await update(dbRef(`users/${currentUser}`), { titles });
        alert('Title added!');
      }
    };

    document.getElementById('sendBtn').onclick = () => {
      const text = document.getElementById('msgInput').value.trim();
      if (!text) return;
      const msgRef = push(dbRef(`rooms/${roomCode}/messages`));
      set(msgRef, {
        sender: currentUser,
        content: text,
        timestamp: Date.now(),
        edited: false
      });
      document.getElementById('msgInput').value = '';
    };

    const chatBox = document.getElementById('chatBox');
    onValue(dbRef(`rooms/${roomCode}/messages`), snapshot => {
      chatBox.innerHTML = '';
      const msgs = snapshot.val() || {};
      Object.entries(msgs).forEach(([key, msg]) => {
        const div = document.createElement('div');
        div.textContent = `${msg.sender}: ${msg.content}${msg.edited ? " (edited)" : ""}`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    document.getElementById('leaveBtn').onclick = () => {
      window.location = 'dashboard.html';
    };
  </script>
</body>
</html>
