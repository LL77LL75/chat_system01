<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App â€“ Chat Room</title>
    <link rel="stylesheet" href="style.css">
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="app.js"></script>
</head>
<body>

<div class="chat-container">

    <!-- Chat Messages -->
    <div id="messages" class="message-list"></div>

    <!-- Message Input -->
    <form id="chat-form" onsubmit="event.preventDefault(); sendMessage();">
        <label for="message-input">Type your message:</label>
        <input id="message-input" type="text" placeholder="Enter message" required>
        <button type="submit">Send</button>
    </form>

    <!-- Leave Chat -->
    <a href="dashboard.html" class="button-link">Leave Chat</a>

    <!-- Admin Panel (Pioneer/Core only) -->
    <div class="admin-panel">
        <h3>Admin Panel</h3>
        <p>Banned Users:</p>
        <ul id="banned-users"></ul>

        <p>Muted Users:</p>
        <ul id="muted-users"></ul>

        <a href="#" onclick="createRoom(prompt('Enter room code'))">Create Room</a>
        <a href="#" onclick="deleteRoom(prompt('Enter room code'))">Delete Room</a>
    </div>

</div>

<script type="module">
import { db } from './firebase-config.js';
import { ref, onValue, push } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js';

const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
const roomCode = new URLSearchParams(window.location.search).get("room");

const messagesRef = ref(db, 'messages/' + roomCode);

// Add join message
push(messagesRef, {
    sender: 'SYSTEM',
    message: joinMessage(currentUser.rank, currentUser.displayName || currentUser.username),
    timestamp: Date.now()
});

function joinMessage(rank, name) {
    switch(rank){
        case 'newbie':
        case 'member':
            return `[${name}] has joined the chat`;
        case 'admin':
        case 'high':
            return `[${name}] joins the chat...`;
        case 'core':
        case 'pioneer':
            return `A GOD HAS ARRIVED`;
        default:
            return `[${name}] has joined`;
    }
}

function leaveMessage(rank, name) {
    switch(rank){
        case 'newbie':
        case 'member':
            return `[${name}] has left the chat`;
        case 'admin':
        case 'high':
            return `[${name}] leaves the chat...`;
        case 'core':
        case 'pioneer':
            return `[${name}] has left`;
        default:
            return `[${name}] has left`;
    }
}

// Listen messages
onValue(messagesRef, snapshot => {
    const container = document.getElementById('messages');
    container.innerHTML = '';
    snapshot.forEach(child => {
        const msg = child.val();
        const div = document.createElement('div');
        div.classList.add('message');
        if(msg.sender === 'SYSTEM'){
            div.style.color = 'gray';
            div.textContent = msg.message;
        } else {
            div.textContent = `[${msg.sender}]: ${msg.message}`;
            if(msg.reactions && msg.reactions.length){
                div.innerHTML += `<br><small>${msg.reactions.join(", ")}</small>`;
            }
        }
        container.appendChild(div);
    });
});

// Send message
window.sendMessage = async function(){
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if(!message) return;
    await push(messagesRef, {
        sender: currentUser.username,
        message: message,
        timestamp: Date.now(),
        reactions: []
    });
    input.value = '';
};

// On leave page
window.addEventListener('beforeunload', async ()=>{
    await push(messagesRef, {
        sender: 'SYSTEM',
        message: leaveMessage(currentUser.rank, currentUser.displayName || currentUser.username),
        timestamp: Date.now()
    });
});
</script>

</body>
</html>
