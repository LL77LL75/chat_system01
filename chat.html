<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Room</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Chat Room</h1>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="index.html">Logout</a>
    </nav>
  </header>

  <main>
    <section id="chat-section">
      <div id="chatBox"></div>
      <input type="text" id="msgInput" placeholder="Type your messageâ€¦" />
      <button id="sendBtn">Send</button>
    </section>

    <section id="moderation-panel">
      <h3>Moderation Panel</h3>
      <div>
        <h4>Banned Users</h4>
        <ul id="bannedList"></ul>
      </div>
      <div>
        <h4>Muted Users</h4>
        <ul id="mutedList"></ul>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = path => ref(db, path);

    const currentUser = localStorage.getItem('chatUser');
    const currentRank = localStorage.getItem('chatRank') || "newbie";
    const params = new URLSearchParams(window.location.search);
    const roomCode = params.get('room');

    if (!currentUser) {
      window.location = "index.html";
    }

    // Send message
    document.getElementById('sendBtn').onclick = () => {
      const txt = document.getElementById('msgInput').value.trim();
      if (!txt) return;
      const msgRef = push(dbRef(`rooms/${roomCode}/messages`));
      set(msgRef, {
        sender: currentUser,
        content: txt,
        timestamp: Date.now(),
        edited: false
      });
      document.getElementById('msgInput').value = '';
    };

    // Display messages
    const chatBox = document.getElementById('chatBox');
    onValue(dbRef(`rooms/${roomCode}/messages`), snap => {
      chatBox.innerHTML = "";
      const msgs = snap.val() || {};
      Object.entries(msgs).forEach(([msgId, msg]) => {
        const div = document.createElement('div');
        div.textContent = `${msg.sender}: ${msg.content}${msg.edited ? " (edited)" : ""}`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Moderation lists
    function refreshModLists() {
      get(dbRef(`rooms/${roomCode}/bans`)).then(snap => {
        const bans = snap.val() || {};
        const bl = document.getElementById('bannedList');
        bl.innerHTML = "";
        Object.keys(bans).forEach(u => {
          const li = document.createElement('li');
          li.textContent = u;
          bl.appendChild(li);
        });
      });
      get(dbRef(`rooms/${roomCode}/mutes`)).then(snap => {
        const mutes = snap.val() || {};
        const ml = document.getElementById('mutedList');
        ml.innerHTML = "";
        Object.keys(mutes).forEach(u => {
          const li = document.createElement('li');
          li.textContent = u;
          ml.appendChild(li);
        });
      });
    }
    refreshModLists();
    onValue(dbRef(`rooms/${roomCode}/bans`), () => refreshModLists());
    onValue(dbRef(`rooms/${roomCode}/mutes`), () => refreshModLists());

    // Command interface: type `?/command args` in console
    window.evalCommand = async function(line) {
      line = line.trim();
      if (!line.startsWith("?/")) {
        console.warn("Commands must start with ?/");
        return;
      }
      const parts = line.slice(2).split(/\s+/);
      const cmd = parts[0];
      const args = parts.slice(1);

      // You will need a rank hierarchy comparison function in your app logic
      // e.g. a mapping: newbie < member < admin < high < core < pioneer
      const rankOrder = {
        newbie: 0,
        member: 1,
        admin: 2,
        high: 3,
        core: 4,
        pioneer: 5
      };

      const myRankVal = rankOrder[currentRank];

      switch (cmd) {
        case "mute": {
          const target = args[0];
          if (!target) {
            console.warn("Usage: ?/mute username");
            break;
          }
          const tSnap = await get(dbRef(`users/${target}`));
          if (!tSnap.exists()) {
            console.warn("User not found:", target);
            break;
          }
          const tData = tSnap.val();
          if (rankOrder[tData.rank] >= myRankVal) {
            console.warn("Cannot mute someone of equal or higher rank");
            break;
          }
          await set(dbRef(`rooms/${roomCode}/mutes/${target}`), { by: currentUser, time: Date.now() });
          console.log(`Muted ${target}`);
          break;
        }

        case "unmute": {
          const target = args[0];
          if (!target) {
            console.warn("Usage: ?/unmute username");
            break;
          }
          const mSnap = await get(dbRef(`rooms/${roomCode}/mutes/${target}`));
          if (!mSnap.exists()) {
            console.warn("Not muted:", target);
            break;
          }
          const rec = mSnap.val();
          const byUser = rec.by;
          const bySnap = await get(dbRef(`users/${byUser}`));
          if (bySnap.exists()) {
            const byData = bySnap.val();
            // Only allow unmute if you are the one who muted, or your rank is higher than the muter's rank
            if (byUser === currentUser || rankOrder[byData.rank] < myRankVal) {
              await remove(dbRef(`rooms/${roomCode}/mutes/${target}`));
              console.log(`Unmuted ${target}`);
            } else {
              console.warn("You may not unmute - insufficient privilege");
            }
          }
          break;
        }

        case "ban": {
          const target = args[0];
          if (!target) {
            console.warn("Usage: ?/ban username");
            break;
          }
          const tSnap = await get(dbRef(`users/${target}`));
          if (!tSnap.exists()) {
            console.warn("User not found:", target);
            break;
          }
          const tData = tSnap.val();
          if (rankOrder[tData.rank] >= myRankVal) {
            console.warn("Cannot ban someone of equal or higher rank");
            break;
          }
          await set(dbRef(`rooms/${roomCode}/bans/${target}`), { by: currentUser, time: Date.now() });
          console.log(`Banned ${target}`);
          break;
        }

        case "unban": {
          const target = args[0];
          if (!target) {
            console.warn("Usage: ?/unban username");
            break;
          }
          const bSnap = await get(dbRef(`rooms/${roomCode}/bans/${target}`));
          if (!bSnap.exists()) {
            console.warn("Not banned:", target);
            break;
          }
          const rec = bSnap.val();
          const byUser = rec.by;
          const bySnap = await get(dbRef(`users/${byUser}`));
          if (bySnap.exists()) {
            const byData = bySnap.val();
            if (byUser === currentUser || rankOrder[byData.rank] < myRankVal) {
              await remove(dbRef(`rooms/${roomCode}/bans/${target}`));
              console.log(`Unbanned ${target}`);
            } else {
              console.warn("You may not unban - insufficient privilege");
            }
          }
          break;
        }

        case "kick": {
          const target = args[0];
          if (!target) {
            console.warn("Usage: ?/kick username");
            break;
          }
          // Remove from participants list
          await remove(dbRef(`rooms/${roomCode}/participants/${target}`));
          console.log(`Kicked ${target}`);
          break;
        }

        // More commands (e.g. promote, etc) as needed

        default:
          console.warn("Unknown command:", cmd);
      }
    };

    console.log("Type commands in console like: ?/mute username , ?/ban username");
  </script>
</body>
</html>
